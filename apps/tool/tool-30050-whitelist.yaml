---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: tool-whitelist-30050
  namespace: web-stock-future
spec:
  ipWhiteList:
    sourceRange:
      - "127.0.0.1/32"      # Local access
      - "10.42.0.0/16"      # K3s internal pod network
      - "192.168.0.0/16"    # Internal LAN network
      - "172.16.0.0/12"     # Docker internal network
      # Thêm IP được phép truy cập vào đây:
      - "14.191.166.230/32"        # Thay bằng IP công ty/nhà của bạn
      - "5.6.7.8/32"        # Thêm IP khác nếu cần
---
# NodePort Service để expose tool service trên port 30050
apiVersion: v1
kind: Service
metadata:
  name: tool-service-nodeport-30050
  namespace: web-stock-future
spec:
  type: NodePort
  selector:
    app: tool-service
  ports:
    - port: 9999
      targetPort: 9999
      nodePort: 30050
      protocol: TCP
---
# Traefik Deployment patch để thêm entryPoint port30050  
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traefik
  namespace: kube-system
spec:
  template:
    spec:
      containers:
      - name: traefik
        args:
        - --entrypoints.web.address=:80
        - --entrypoints.websecure.address=:443
        - --entrypoints.port30050.address=:30050
        - --providers.kubernetescrd
        - --providers.kubernetescrd.allowCrossNamespace=true
        - --providers.kubernetesingress
        - --api.dashboard=true
        ports:
        - containerPort: 80
          name: web
          protocol: TCP
        - containerPort: 443
          name: websecure
          protocol: TCP
        - containerPort: 30050
          name: port30050
          protocol: TCP
---
# Traefik Service để expose port 30050
apiVersion: v1
kind: Service
metadata:
  name: traefik-30050
  namespace: kube-system
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: traefik
  ports:
  - port: 30050
    name: port30050
    targetPort: 30050
    nodePort: 30050
    protocol: TCP
---
# IngressRoute để route traffic port 30050 qua middleware whitelist
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: nodeport-30050-whitelist
  namespace: web-stock-future
spec:
  entryPoints:
    - port30050
  routes:
    - match: HostRegexp(`{host:.+}`)
      kind: Rule
      services:
        - name: tool-service-nodeport-30050
          port: 9999
      middlewares:
        - name: tool-whitelist-30050